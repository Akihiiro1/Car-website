<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home - Car Care Guide</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> 
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #000000; color: #fff; }
    .gradient-text {
      background: linear-gradient(90deg, #3b82f6, #10b981);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .glow-card { transition: all 0.3s ease; }
    .glow-card:hover { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); transform: translateY(-5px); }
    .vehicle-card { transition: all 0.3s ease; transform: perspective(1000px) rotateX(0deg); }
    .vehicle-card:hover {
      transform: perspective(1000px) rotateX(10deg);
      box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.1), 0 10px 10px -5px rgba(59, 130, 246, 0.04);
    }
    .select-arrow {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%233b82f6' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; appearance: none;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #ffffff;
      border-radius: 50%; width: 1.5rem; height: 1.5rem;
      animation: spin 1s linear infinite; margin-left: 0.5rem;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .card-actions {
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .vehicle-card:hover .card-actions {
      opacity: 1;
    }
  </style>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { primary: '#3b82f6', dark: '#0f172a', darker: '#020617', accent: '#f59e0b', } } }
    }
  </script>
</head>
<body class="min-h-screen flex flex-col">
  
  <header class="bg-gray-900 border-b border-gray-800 sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <a href="/" class="flex items-center space-x-2">
            <div class="bg-blue-500 p-2 rounded-lg"><i class="fas fa-tools text-white"></i></div>
            <span class="text-white font-bold text-xl">Car Care <span class="gradient-text">Guide</span></span>
          </a>
        </div>
        
        <div class="hidden md:block">
          <div class="ml-10 flex items-center space-x-4">
            <a href="about.html" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">About Us</a>
            <a href="maintenance.html" class="restricted-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Maintenance</a>
            <a href="parts.html" class="restricted-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Parts & Tools</a>
            <a href="contact.html" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Contact</a>
          </div>
        </div>
        
        <div class="hidden md:block">
          <div class="ml-4 flex items-center md:ml-6" id="authContainer">
            <div class="relative mr-4">
              <input type="text" placeholder="Search..." class="bg-gray-800 text-white px-4 py-1 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
              <button class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white"><i class="fas fa-search"></i></button>
            </div>

            <button id="mainSignInButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-full text-sm">Sign in</button>
            
            <div id="userInfoDisplay" class="hidden flex items-center ml-4 space-x-4">
                <span class="text-sm text-gray-300">Welcome, <strong id="usernameDisplay" class="text-white font-semibold"></strong></span>
                <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full text-xs font-medium">Sign Out</button>
            </div>
          </div>
        </div>
        
        <div class="-mr-2 flex md:hidden">
          <button type="button" class="bg-gray-900 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none" aria-controls="mobile-menu" aria-expanded="false">
            <span class="sr-only">Open main menu</span><i class="fas fa-bars"></i>
          </button>
        </div>
      </div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
    <div class="flex flex-col lg:flex-row gap-8">
      
      <aside class="lg:w-1/4 bg-dark p-6 rounded-xl border border-gray-800 h-fit sticky top-24">
        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
          <i class="fas fa-car mr-2 text-accent"></i> Pick Your Vehicle
        </h2>
        
        <div class="space-y-4">
          <div>
            <label for="make" class="block text-sm font-medium text-gray-300 mb-1">Make</label>
            <select id="make" class="select-arrow bg-gray-800 border border-gray-700 text-white rounded-md px-4 py-2 pr-8 w-full focus:ring-2 focus:ring-accent focus:border-accent transition-colors">
              <option value="">Select Make</option>
            </select>
          </div>
          <div>
            <label for="model" class="block text-sm font-medium text-gray-300 mb-1">Model</label>
            <select id="model" disabled class="select-arrow bg-gray-800 border border-gray-700 text-gray-500 rounded-md px-4 py-2 pr-8 w-full">
              <option value="">Select Model</option>
            </select>
          </div>
          <div>
            <label for="year" class="block text-sm font-medium text-gray-300 mb-1">Year</label>
            <select id="year" disabled class="select-arrow bg-gray-800 border border-gray-700 text-gray-500 rounded-md px-4 py-2 pr-8 w-full">
              <option value="">Select Year</option>
            </select>
          </div>
          
          <button id="find-guides" disabled class="w-full bg-[#0066cc] hover:bg-[#3385ff] text-white font-medium py-2 px-4 rounded-md transition-colors flex items-center justify-center mt-4">
            <i class="fas fa-wrench mr-2"></i> Find Guides
          </button>
          
          <div id="guides-container" class="mt-6"></div>
        </div>
        
        <div class="mt-6 pt-6 border-t border-gray-800">
          <h3 class="text-lg font-medium text-white mb-3">Popular Categories</h3>
          <ul class="space-y-2">
            <li><a href="services/oil-change.html" class="restricted-link text-gray-300 hover:text-accent transition-colors flex items-center"><i class="fas fa-oil-can text-xs mr-2"></i> Oil Change</a></li>
            <li><a href="services/battery-replacement.html" class="restricted-link text-gray-300 hover:text-accent transition-colors flex items-center"><i class="fas fa-bolt text-xs mr-2"></i> Battery Replacement</a></li>
            <li><a href="services/tire-rotation.html" class="restricted-link text-gray-300 hover:text-accent transition-colors flex items-center"><i class="fas fa-ring text-xs mr-2"></i> Tire Rotation</a></li>
          </ul>
        </div>
      </aside>
      
      <section class="lg:w-3/4">
        <div class="bg-gradient-to-r from-dark to-gray-900 rounded-xl p-6 border border-gray-800 mb-8">
          <h1 class="text-3xl md:text-4xl font-bold text-white mb-3">DIY Car Repair <span class="text-accent">Made Simple</span></h1>
          <p class="text-lg text-gray-300 mb-6">Browse step-by-step guides and videos to maintain and repair your vehicle like a pro</p>
          <div class="flex flex-wrap gap-3">
            <button id="watch-tutorials" class="bg-[#0066cc] hover:bg-[#3385ff] text-white px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center">
              <i class="fas fa-play-circle mr-2"></i> Watch Tutorials
            </button>
            <button id="get-help" class="bg-transparent hover:bg-gray-800 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors border border-gray-700 flex items-center">
              <i class="fas fa-question-circle mr-2"></i> Get Help
            </button>
          </div>
        </div>

        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white flex items-center">
               <i class="fas fa-car-side mr-3 text-accent"></i> Browse by Make
            </h2>
            <button id="addVehicleBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center">
                <i class="fas fa-plus mr-2"></i> Add Vehicle
            </button>
        </div>

        <div id="car-cards-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>

        <div class="mt-12 bg-dark rounded-xl p-6 border border-gray-800">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center"><i class="fas fa-fire text-accent mr-3"></i> Trending Guides</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <a href="services/oil-change.html" class="flex items-start space-x-4 cursor-pointer hover:bg-gray-800 p-2 rounded restricted-link transition">
                    <div class="flex-shrink-0 bg-gray-800 p-3 rounded-lg"><i class="fas fa-oil-can text-accent text-xl"></i></div>
                    <div>
                        <h3 class="text-lg font-medium text-white">How to Change Your Oil</h3>
                        <p class="text-gray-400 mt-1">Learn the proper way to change your engine oil.</p>
                    </div>
                </a>
                <a href="services/battery-replacement.html" class="flex items-start space-x-4 cursor-pointer hover:bg-gray-800 p-2 rounded restricted-link transition">
                    <div class="flex-shrink-0 bg-gray-800 p-3 rounded-lg"><i class="fas fa-bolt text-accent text-xl"></i></div>
                    <div>
                        <h3 class="text-lg font-medium text-white">Battery Replacement</h3>
                        <p class="text-gray-400 mt-1">Safely replace your car battery at home.</p>
                    </div>
                </a>
            </div>
        </div>

      </section>
    </div>
  </main>

  <footer class="bg-gray-900 border-t border-gray-800 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col md:flex-row justify-between items-center">
        <p class="text-gray-400">&copy; 2025 Car Care Guide. All rights reserved.</p>
        <div class="flex space-x-6 mt-4 md:mt-0">
          <a href="#" class="text-gray-400 hover:text-white text-sm">Privacy</a>
          <a href="#" class="text-gray-400 hover:text-white text-sm">Terms</a>
        </div>
    </div>
  </footer>

  <div id="signinpopupBg" class="fixed inset-0 bg-black/70 hidden z-50 transition-opacity duration-300"></div>
  <div id="signinpopup" class="fixed inset-0 flex items-center justify-center hidden p-4 z-50">
    <div class="bg-gray-900 rounded-xl p-6 w-full max-w-xs shadow-2xl">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-white">Sign In</h2>
            <button class="text-white hover:text-gray-300" id="closeSignInPopup"><i class="fas fa-times"></i></button>
        </div>
        <div id="messageBox" class="hidden p-3 mb-4 rounded-lg text-sm"></div>
        <form id="loginForm">
            <input type="text" id="username" placeholder="Username" class="w-full mb-4 px-4 py-3 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <input type="password" id="password" placeholder="Password" class="w-full mb-4 px-4 py-3 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <button type="submit" id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-3 rounded-lg flex justify-center items-center">
                Log In <div id="loginSpinner" class="hidden spinner"></div>
            </button>
            <h2 class="text-sm text-gray-400 mt-4 text-center">Don't have an account? <a href="#" id="signupLink" class="text-blue-400 hover:underline">Sign Up</a></h2>
        </form>
    </div>
  </div>

  <div id="signuppopupBg" class="fixed inset-0 bg-black/70 hidden z-50 transition-opacity duration-300"></div>
  <div id="signuppopup" class="fixed inset-0 flex items-center justify-center hidden p-4 z-50">
    <div class="bg-gray-900 rounded-xl p-6 w-full max-w-xs shadow-2xl">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-white">Create Account</h2>
            <button class="text-white hover:text-gray-300" id="closeSignUpPopup"><i class="fas fa-times"></i></button>
        </div>
        <div id="signUpMessageBox" class="hidden p-3 mb-4 rounded-lg text-sm"></div>
        <form id="signUpForm">
            <input type="text" id="signUpUsername" placeholder="Username" class="w-full mb-4 px-4 py-3 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <input type="email" id="signUpEmail" placeholder="Email" class="w-full mb-4 px-4 py-3 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <input type="password" id="signUpPassword" placeholder="Password" class="w-full mb-4 px-4 py-3 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <input type="password" id="signUpConfirmPassword" placeholder="Confirm Password" class="w-full mb-4 px-4 py-3 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <button type="submit" id="signUpButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-3 rounded-lg flex justify-center items-center">
                Sign Up <div id="signUpSpinner" class="hidden spinner"></div>
            </button>
            <h2 class="text-sm text-gray-400 mt-4 text-center">Already have an account? <a href="#" id="signInLink" class="text-blue-400 hover:underline">Sign In</a></h2>
        </form>
    </div>
  </div>

  <div id="vehicleModalBg" class="fixed inset-0 bg-black/70 hidden z-50 transition-opacity duration-300"></div>
  <div id="vehicleModal" class="fixed inset-0 flex items-center justify-center hidden p-4 z-50">
    <div class="bg-gray-900 rounded-xl p-6 w-full max-w-md shadow-2xl border border-gray-700">
        <div class="flex items-center justify-between mb-4">
            <h2 id="modalTitle" class="text-2xl font-bold text-white">Add Vehicle</h2>
            <button class="text-white hover:text-gray-300" id="closeVehicleModal"><i class="fas fa-times"></i></button>
        </div>
        <form id="vehicleForm">
            <input type="hidden" id="vehicleId">
            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-1">Make (Brand)</label>
                <input type="text" id="vehicleMake" placeholder="e.g., Toyota" class="w-full px-4 py-2 rounded-lg bg-gray-800 text-white focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-1">Image URL</label>
                <input type="url" id="vehicleImage" placeholder="https://..." class="w-full px-4 py-2 rounded-lg bg-gray-800 text-white focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-1">Guide Count</label>
                <input type="text" id="vehicleGuides" placeholder="e.g., 25+ guides" class="w-full px-4 py-2 rounded-lg bg-gray-800 text-white focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" id="cancelVehicleBtn" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold">Save Vehicle</button>
            </div>
        </form>
    </div>
  </div>

  <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
    <div class="bg-[#1a1a1a] rounded-xl p-8 max-w-md w-full border border-gray-800 relative">
      <button id="close-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-xl">&times;</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <script>
    const BASE_URL = 'http://localhost:3000/api'; 
    const LOGIN_API_URL = BASE_URL + '/login'; 
    const REGISTER_API_URL = BASE_URL + '/register'; 
    const VEHICLES_API_URL = BASE_URL + '/vehicles';

    document.addEventListener('DOMContentLoaded', function() {
      const mainSignInButton = document.getElementById('mainSignInButton');
      const logoutButton = document.getElementById('logoutButton');
      const userInfoDisplay = document.getElementById('userInfoDisplay');
      const usernameDisplay = document.getElementById('usernameDisplay');
      
      const signinpopup = document.getElementById('signinpopup');
      const signinpopupBg = document.getElementById('signinpopupBg');
      const signuppopup = document.getElementById('signuppopup');
      const signuppopupBg = document.getElementById('signuppopupBg');
      
      const messageBox = document.getElementById('messageBox');
      const signUpMessageBox = document.getElementById('signUpMessageBox');
      
      const initialCars = [
        { id: '1', make: 'Acura', image_url: 'https://images.pexels.com/photos/170811/pexels-photo-170811.jpeg', guide_count: '25+ guides' },
        { id: '2', make: 'BMW', image_url: 'https://images.pexels.com/photos/120049/pexels-photo-120049.jpeg', guide_count: '45+ guides' },
        { id: '3', make: 'Audi', image_url: 'https://images.pexels.com/photos/892522/pexels-photo-892522.jpeg', guide_count: '32+ guides' },
        { id: '4', make: 'Chevrolet', image_url: 'https://images.pexels.com/photos/337909/pexels-photo-337909.jpeg', guide_count: '50+ guides' },
        { id: '5', make: 'Cadillac', image_url: 'https://images.pexels.com/photos/3874337/pexels-photo-3874337.jpeg', guide_count: '28+ guides' }
      ];
      
      function showModal(popup, bg) {
          bg.classList.remove('hidden');
          popup.classList.remove('hidden');
      }

      function hideModal(popup, bg) {
          popup.classList.add('hidden');
          bg.classList.add('hidden');
          if(messageBox) messageBox.classList.add('hidden');
          if(signUpMessageBox) signUpMessageBox.classList.add('hidden');
      }

      function showMessage(element, text, classes) {
          element.textContent = text;
          element.classList.remove('hidden');
          element.className = `p-3 mb-4 rounded-lg text-sm ${classes}`;
      }

      function updateAuthUI(username) {
          if (username) {
              mainSignInButton.classList.add('hidden');
              userInfoDisplay.classList.remove('hidden');
              usernameDisplay.textContent = username;
          } else {
              mainSignInButton.classList.remove('hidden');
              userInfoDisplay.classList.add('hidden');
              usernameDisplay.textContent = '';
          }
      }

      function getAuthHeaders() {
          const token = localStorage.getItem('token');
          return { headers: { Authorization: `Bearer ${token}` } };
      }

      function getLocalCars() {
          const stored = localStorage.getItem('carsData');
          try {
              if (stored) {
                  const parsed = JSON.parse(stored);
                  if (parsed && parsed.length > 0) return parsed;
              }
          } catch (e) {
              console.error("Error parsing carsData:", e);
          }
          localStorage.setItem('carsData', JSON.stringify(initialCars));
          return initialCars;
      }

      function saveLocalCars(cars) {
          localStorage.setItem('carsData', JSON.stringify(cars));
      }

      const savedUsername = localStorage.getItem('username');
      updateAuthUI(savedUsername);

      if (!localStorage.getItem('carsData') || localStorage.getItem('carsData') === '[]') {
          localStorage.setItem('carsData', JSON.stringify(initialCars));
      }

        async function fetchCars() {
          let allCars = Array.isArray(initialCars) ? [...initialCars] : [];

          try {
            const stored = localStorage.getItem('carsData');
            if (stored) {
              const parsed = JSON.parse(stored);
              if (Array.isArray(parsed)) {
                parsed.forEach(sc => {
                  const exists = allCars.some(c => String(c.id) === String(sc.id) || (c.make && sc.make && c.make === sc.make));
                  if (!exists) allCars.push(sc);
                });
              }
            }
          } catch (e) {
            console.error('Error reading stored cars:', e);
          }

          try {
            const response = await axios.get(VEHICLES_API_URL, { params: { _t: Date.now() } });
            if (response.data && Array.isArray(response.data)) {
              response.data.forEach(backendCar => {
                const exists = allCars.some(c => String(c.id) === String(backendCar.id) || (c.make && backendCar.make && c.make === backendCar.make));
                if (!exists) allCars.push(backendCar);
              });

              saveLocalCars(allCars);
            }
          } catch (error) {
            console.warn('Backend unavailable, continuing with local/initial cars.');
          }

          console.debug('fetchCars -> returning', allCars);
          return allCars;
        }

      async function renderCarCards() {
          const grid = document.getElementById('car-cards-grid');
          const makeSelect = document.getElementById('make');
          
          grid.innerHTML = '<div class="col-span-full text-center py-10"><div class="spinner inline-block"></div> Loading vehicles...</div>';
          
          const cars = await fetchCars();
          console.debug('renderCarCards -> received cars', cars);
          
          grid.innerHTML = '';
          makeSelect.innerHTML = '<option value="">Select Make</option>';

          if (!cars || cars.length === 0) {
             grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">No vehicles found. Add one!</div>';
             return;
          }

          cars.forEach(car => {
              const option = document.createElement('option');
              const makeLabel = (car.make || car.make_name || car.Make || 'Unknown').toString();
              option.value = makeLabel.toLowerCase().replace(/\s+/g, '-');
              option.textContent = makeLabel;
              makeSelect.appendChild(option);

              const image = car.image_url || car.image || car.imageUrl || 'https://via.placeholder.com/400x300?text=Car+Image';
              const guides = car.guide_count || car.guides || '0 guides';

              const card = document.createElement('div');
              card.className = "vehicle-card bg-dark rounded-lg overflow-hidden border border-gray-800 hover:border-accent/30 group relative";
              card.innerHTML = `
                <a href="brands/${car.make.toLowerCase()}.html" class="block">
                   <div class="relative overflow-hidden h-40">
                     <img src="${image}" alt="${car.make}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.src='https://via.placeholder.com/400x300?text=Car+Image'">
                     <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                   </div>
                   <div class="p-4">
                     <h3 class="text-white font-medium group-hover:text-accent">${makeLabel}</h3>
                     <p class="text-gray-400 text-sm mt-1">${guides}</p>
                   </div>
                </a>
                
                <div class="card-actions absolute top-2 right-2 flex gap-2">
                    <button class="edit-btn bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-lg text-xs" 
                        data-id="${car.id}" 
                        data-make="${car.make}" 
                        data-image="${image}" 
                        data-guides="${guides}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-full shadow-lg text-xs" data-id="${car.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
              `;
              grid.appendChild(card);
          });
          
          attachCardListeners();
      }

      function attachCardListeners() {
          document.querySelectorAll('.delete-btn').forEach(btn => {
              btn.addEventListener('click', async (e) => {
                  e.preventDefault();
                  e.stopPropagation(); 
                  
                  const token = localStorage.getItem('token');
                  if (!token) {
                      showModal(signinpopup, signinpopupBg);
                      if(messageBox) showMessage(messageBox, "Please log in to delete a vehicle.", "bg-blue-600 text-white");
                      return;
                  }

                  const id = e.currentTarget.dataset.id;
                  if(confirm("Are you sure you want to delete this car?")) {
                      try {
                          await axios.delete(`${VEHICLES_API_URL}/${id}`, getAuthHeaders());
                      } catch (err) {
                          console.warn("Backend delete failed, using local storage");
                          let cars = getLocalCars();
                          cars = cars.filter(c => String(c.id) !== String(id));
                          saveLocalCars(cars);
                      }
                      renderCarCards();
                  }
              });
          });

          document.querySelectorAll('.edit-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                  e.preventDefault();
                  e.stopPropagation();

                  const token = localStorage.getItem('token');
                  if (!token) {
                      showModal(signinpopup, signinpopupBg);
                      if(messageBox) showMessage(messageBox, "Please log in to edit a vehicle.", "bg-blue-600 text-white");
                      return;
                  }

                  const data = e.currentTarget.dataset;
                  document.getElementById('vehicleId').value = data.id;
                  document.getElementById('vehicleMake').value = data.make;
                  document.getElementById('vehicleImage').value = data.image;
                  document.getElementById('vehicleGuides').value = data.guides;
                  
                  document.getElementById('modalTitle').textContent = "Edit Vehicle";
                  showModal(document.getElementById('vehicleModal'), document.getElementById('vehicleModalBg'));
              });
          });
      }

      const vehicleModal = document.getElementById('vehicleModal');
      const vehicleModalBg = document.getElementById('vehicleModalBg');
      const vehicleForm = document.getElementById('vehicleForm');

      document.getElementById('addVehicleBtn').addEventListener('click', () => {
          const token = localStorage.getItem('token');
          if (!token) {
              showModal(signinpopup, signinpopupBg);
              if(messageBox) showMessage(messageBox, "Please log in to add a vehicle.", "bg-blue-600 text-white");
              return;
          }

          vehicleForm.reset();
          document.getElementById('vehicleId').value = '';
          document.getElementById('modalTitle').textContent = "Add Vehicle";
          showModal(vehicleModal, vehicleModalBg);
      });

      document.getElementById('closeVehicleModal').addEventListener('click', () => hideModal(vehicleModal, vehicleModalBg));
      document.getElementById('cancelVehicleBtn').addEventListener('click', () => hideModal(vehicleModal, vehicleModalBg));

      vehicleForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const id = document.getElementById('vehicleId').value;
          
          const payload = {
              make: document.getElementById('vehicleMake').value,
              image_url: document.getElementById('vehicleImage').value,
              guide_count: document.getElementById('vehicleGuides').value
          };

          try {
              if (id) {
                  const response = await axios.put(`${VEHICLES_API_URL}/${id}`, payload, getAuthHeaders());
                  let cars = getLocalCars();
                  const index = cars.findIndex(c => String(c.id) === String(id));
                  if (index !== -1) {
                      cars[index] = { id, ...payload };
                  }
                  saveLocalCars(cars);
              } else {
                  const response = await axios.post(VEHICLES_API_URL, payload, getAuthHeaders());
                  const newVehicle = response.data || { id: Date.now().toString(), ...payload };
                  let cars = getLocalCars();
                  cars.push(newVehicle);
                  saveLocalCars(cars);
              }
          } catch (err) {
              console.warn("Backend save failed, using local storage");
              let cars = getLocalCars();
              if (id) {
                  const index = cars.findIndex(c => String(c.id) === String(id));
                  if (index !== -1) {
                      cars[index] = { id, ...payload };
                  }
              } else {
                  const newId = Date.now().toString();
                  cars.push({ id: newId, ...payload });
              }
              saveLocalCars(cars);
          }
          
          hideModal(vehicleModal, vehicleModalBg);
          await renderCarCards();
      });

      renderCarCards();
      
      document.addEventListener('click', function(event) {
        const link = event.target.closest('.restricted-link');
        if (link) {
            const token = localStorage.getItem('token');
            if (!token) {
                event.preventDefault();
                event.stopPropagation();
                showModal(signinpopup, signinpopupBg);
                if(messageBox) showMessage(messageBox, "Please log in to access this feature.", "bg-blue-600 text-white");
            }
        }
      });

      if(mainSignInButton) mainSignInButton.addEventListener('click', () => showModal(signinpopup, signinpopupBg));
      document.getElementById('closeSignInPopup').addEventListener('click', () => hideModal(signinpopup, signinpopupBg));
      document.getElementById('closeSignUpPopup').addEventListener('click', () => hideModal(signuppopup, signuppopupBg));

      document.getElementById('signupLink').addEventListener('click', (e) => {
          e.preventDefault();
          hideModal(signinpopup, signinpopupBg);
          showModal(signuppopup, signuppopupBg);
      });

      document.getElementById('signInLink').addEventListener('click', (e) => {
          e.preventDefault();
          hideModal(signuppopup, signuppopupBg);
          showModal(signinpopup, signinpopupBg);
      });

      if (logoutButton) {
          logoutButton.addEventListener('click', () => {
              localStorage.removeItem('token');
              localStorage.removeItem('username');
              updateAuthUI(null);
              window.location.reload(); 
          });
      }

      document.getElementById('loginForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          const btn = document.getElementById('loginButton');
          const spinner = document.getElementById('loginSpinner');

          btn.disabled = true;
          spinner.classList.remove('hidden');
          
          try {
              const response = await axios.post(LOGIN_API_URL, { username, password });
              localStorage.setItem('token', response.data.token);
              localStorage.setItem('username', response.data.user.username);
              updateAuthUI(response.data.user.username);
              showMessage(messageBox, "Login Successful!", "bg-green-600 text-white");
              hideModal(signinpopup, signinpopupBg);
              await renderCarCards();
          } catch (error) {
              console.warn("Login failed (likely network error). Proceeding offline.");
              if (error.code === "ERR_NETWORK") {
                   showMessage(messageBox, "Network error. Server offline.", "bg-yellow-600 text-white");
              } else {
                   const msg = error.response ? error.response.data.message : "Server error";
                   showMessage(messageBox, msg, "bg-red-600 text-white");
              }
          } finally {
              btn.disabled = false;
              spinner.classList.add('hidden');
          }
      });

      document.getElementById('signUpForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const username = document.getElementById('signUpUsername').value;
          const email = document.getElementById('signUpEmail').value;
          const password = document.getElementById('signUpPassword').value;
          const confirm = document.getElementById('signUpConfirmPassword').value;
          const btn = document.getElementById('signUpButton');
          const spinner = document.getElementById('signUpSpinner');

          if(password !== confirm) {
              showMessage(signUpMessageBox, "Passwords do not match", "bg-red-600 text-white");
              return;
          }

          btn.disabled = true;
          spinner.classList.remove('hidden');

          try {
              await axios.post(REGISTER_API_URL, { username, email, password });
              showMessage(signUpMessageBox, "Account created! Please log in.", "bg-green-600 text-white");
              setTimeout(() => {
                  hideModal(signuppopup, signuppopupBg);
                  showModal(signinpopup, signinpopupBg);
                  showMessage(messageBox, "Account created! Please log in.", "bg-green-600 text-white");
              }, 1500);
          } catch (error) {
              const msg = error.response ? error.response.data.message : "Server error";
              showMessage(signUpMessageBox, msg, "bg-red-600 text-white");
          } finally {
              btn.disabled = false;
              spinner.classList.add('hidden');
          }
      });

      const mobileMenuButton = document.querySelector('[aria-controls="mobile-menu"]');
      const mobileMenu = document.createElement('div');
      mobileMenu.id = 'mobile-menu';
      mobileMenu.className = 'hidden md:hidden bg-gray-900 px-4 py-2';
      
      const menuLinks = [
        {text: 'About Us', href: 'about.html'},
        {text: 'Maintenance', href: 'maintenance.html', restricted: true},
        {text: 'Parts & Tools', href: 'parts.html', restricted: true},
        {text: 'Contact', href: 'contact.html'}
      ];

      menuLinks.forEach(link => {
        const a = document.createElement('a');
        a.href = link.href;
        a.className = 'block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-700';
        if(link.restricted) a.classList.add('restricted-link');
        a.textContent = link.text;
        mobileMenu.appendChild(a);
      });
      
      document.body.appendChild(mobileMenu);
      
      mobileMenuButton.addEventListener('click', function() {
        const expanded = this.getAttribute('aria-expanded') === 'true';
        this.setAttribute('aria-expanded', !expanded);
        mobileMenu.classList.toggle('hidden');
      });

      const modelSelect = document.getElementById('model');
      const yearSelect = document.getElementById('year');
      const findButton = document.getElementById('find-guides');
      const guidesContainer = document.getElementById('guides-container');
      
      const yearData = ['2023', '2022', '2021', '2020', '2019', '2018', '2017', '2016'];
      
      document.getElementById('make').addEventListener('change', function() {
          if (this.value) {
              modelSelect.disabled = false;
              modelSelect.innerHTML = '<option value="">Select Model</option>';
              ['Model A', 'Model B', 'Sport', 'Utility'].forEach(m => {
                 const opt = document.createElement('option');
                 opt.value = m; opt.textContent = m;
                 modelSelect.appendChild(opt);
              });
              modelSelect.classList.remove('text-gray-500');
              modelSelect.classList.add('text-white');
          } else {
              modelSelect.disabled = true;
              yearSelect.disabled = true;
          }
      });

      modelSelect.addEventListener('change', function() {
        if (this.value) {
            yearSelect.disabled = false;
            yearSelect.innerHTML = '<option value="">Select Year</option>';
            yearData.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            yearSelect.classList.remove('text-gray-500');
            yearSelect.classList.add('text-white');
        } else {
            yearSelect.disabled = true;
        }
      });
      
      yearSelect.addEventListener('change', function() {
        findButton.disabled = !this.value;
      });

      findButton.addEventListener('click', function() {
          guidesContainer.innerHTML = `<div class='bg-[#1a1a1a] rounded-xl p-4 border border-gray-800 mt-4 text-white'>Loading guides...</div>`;
      });

      const modalOverlay = document.getElementById('modal-overlay');
      const modalContent = document.getElementById('modal-content');
      document.getElementById('close-modal').addEventListener('click', () => modalOverlay.classList.add('hidden'));

      document.getElementById('watch-tutorials').addEventListener('click', () => {
          modalContent.innerHTML = `<h2 class='text-2xl font-bold text-white mb-4'>How to Watch</h2><p class='text-gray-300'>Browse car cards or use the selector.</p>`;
          modalOverlay.classList.remove('hidden');
      });
      
      document.getElementById('get-help').addEventListener('click', () => {
          modalContent.innerHTML = `<h2 class='text-2xl font-bold text-white mb-4'>Get Help</h2><p class='text-gray-300'>Visit the Contact page for support.</p>`;
          modalOverlay.classList.remove('hidden');
      });
    });
  </script>
</body>
</html>